name: Empty backport self-closing
on: [ pull_request ]
jobs:
  new-dependabot-pr:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'backport/')
    permissions: write-all
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}
      - name: Check for uncommitted changes
        id: check-changes
        uses: mskri/check-uncommitted-changes-action@v1.0.1
      - name: Print uncommitted changes
        if: steps.check-changes.outputs.changes != ''
        run: echo "There are uncommitted changes"
      - name: Check if there are changes
        id: changes
        uses: UnicornGlobal/has-changes-action@v1.0.11
      - name: Process changes
        if: steps.changes.outputs.changed == 0
        run: echo "Changes exist Daniela"
      - name: Self-closing
        if: steps.changes.outputs.changed == 1
        uses: actions/github-script@v5
        with:
          script: |
            const branch = "${{ steps.branch-name.outputs.branch }}";

            //Close pull request
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.number }},
              state: 'closed'
            })

            //Delete branch
            await github.rest.git.deleteRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: "heads/${{ github.event.pull_request.head.ref }}"
            });
